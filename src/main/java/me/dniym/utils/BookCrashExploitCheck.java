package main.java.me.dniym.utils;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.reflect.StructureModifier;
import org.bukkit.entity.Player;
import org.bukkit.inventory.InventoryView;
import org.bukkit.plugin.Plugin;

public class BookCrashExploitCheck extends PacketAdapter {

    public BookCrashExploitCheck(final Plugin plugin) {
        super(plugin, PacketType.Play.Client.WINDOW_CLICK);
    }

    @Override
    public void onPacketReceiving(final PacketEvent event) {
        Player player = event.getPlayer();
        StructureModifier<Integer> integers = event.getPacket().getIntegers();

        if (player != null) {
            final InventoryView inventoryView = event.getPlayer().getOpenInventory();

            if (inventoryView != null && integers.size() > 1) {
                final int slot = integers.read(1) - 3;
                final int maxSlots = inventoryView.countSlots();
                PacketAttack pa = PacketAttack.findPlayer(player.getUniqueId());
                if (slot > maxSlots || slot < 0) {
                    event.setCancelled(pa.addAttempt(event, "WINDOW_INVALID_CLICK"));
                } else {
                    event.setCancelled(pa.addAttempt(event, "WINDOW_CLICK_SPAM"));
                }
            }
        } //else
        //event.setCancelled(true);
    }

}
